<!DOCTYPE html>
<html>

    <title>Place Autocomplete</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script> 
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <body>
        <script>

            var gjson;
            var map;
            var loc;
            var markers = [];
            // Add start point for the route
            function pickup() {
                var autocomplete = new google.maps.places.Autocomplete((document.getElementById('pickup')), {types: ['geocode']});
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    var place = autocomplete.getPlace();
                    start = {
                        'lat': place.geometry.location.lat(),
                        'lng': place.geometry.location.lng(),
                        'address': place.address_components[0].long_name
                    }
                });
            }
            // Add end point for the route
            function dropoff() {
                var autocomplete = new google.maps.places.Autocomplete((document.getElementById('dropoff')), {types: ['geocode']});
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    var place = autocomplete.getPlace();
                    end = {
                        'lat': place.geometry.location.lat(),
                        'lng': place.geometry.location.lng(),
                        'address': place.address_components[0].long_name
                    }
                });
            }
            // Request the route
            function route() {
                var request = {
                    origin: new google.maps.LatLng(start['lat'], start['lng']),
                    destination: new google.maps.LatLng(end['lat'], end['lng']),
                    optimizeWaypoints: false,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC
                };
                var directionsService = new google.maps.DirectionsService();
                directionsService.route(request, function(result, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(result);
                        gjson = result;
                    }
                });
            }
            // Request the price
            function price() {

                var distance = 0;
                var legs = [];
                var duration = 0;
                var route = gjson.routes[0];
                var n = route.legs.length;
                var points_list = new Array();
                for (i = 0; i < n; i++) {
                    distance += route.legs[i].distance.value;
                    duration += Math.round(route.legs[i].duration.value);
                    var first_point = {
                        'lng': route.legs[0].start_location.lng(),
                        'lat': route.legs[0].start_location.lat(),
                        "type": "p",
                        "address": route.legs[0].start_address
                    };
                    points_list.push(first_point);
                    var dropoff_point = {
                        'lng': route.legs[0].end_location.lng(),
                        'lat': route.legs[0].end_location.lat(),
                        "type": "d",
                        "address": route.legs[i].end_address
                    };
                    legs.push(route.legs[i].distance.value);
                }
                obj = {
                    "priceList": [
                        {
                            "Booking": {
                                "id_client": 102480,
                                "id_car_type": 2,
                                "payment_method": "CREDIT ONLINE",
                                "transfer_type": "local"
                            },
                            "BookingCharge": {
                                "com_cash": 1,
                                "com_credit": 2,
                                "driver_tip": 2
                            },
                            "Journey": {
                                "child_seats_number": 5,
                                "req_baby_seat": "yes",
                                "extra_duration_delay": 0,
                                "pickup_time": "2015-01-21 13:00:00",
                                "journey_type": "localaddress-localaddress"
                            },
                            "RouteInfo": {
                                "points_list": [
                                    {
                                        'lng': gjson.routes[0].legs[0].start_location.B,
                                        'lat': gjson.routes[0].legs[0].start_location.k,
                                        "type": "p",
                                        "address": gjson.routes[0].legs[0].start_address
                                    },
                                    {
                                        'lng': gjson.routes[0].legs[0].end_location.B,
                                        'lat': gjson.routes[0].legs[0].end_location.k,
                                        "type": "d",
                                        "address": gjson.routes[0].legs[0].end_address
                                    }

                                ],
                                "distance": distance,
                                "duration": duration,
                                "old_distance": 0,
                                "legs": legs
                            }
                        }
                    ]};
                QuoteService();
            }
            // Get the Json from server
            function QuoteService() {
                $.ajax({
                    type: 'POST',
                    url: "https://api_test_gtn.insoftd.com/v1/operator/price/new",
                    dataType: "json",
                    data: JSON.stringify(obj),
                    contentType: 'application/json',
                    success: function(data) {
                        document.getElementById('json').innerHTML = 'The price will be ' + data.records.totalPrice + ' &pound; and the distance covered is ' + gjson.routes[0].legs[0].distance.text;
                        console.log(data);
                    },
                    async: true
                });
            }
            // Autocomplete for search
            function sch() {
                var autocomplete = new google.maps.places.Autocomplete((document.getElementById('search')), {types: ['geocode']});
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    var place = autocomplete.getPlace();
                    console.log(autocomplete);
                    start = {
                        'lat': place.geometry.location.lat(),
                        'lng': place.geometry.location.lng(),
                        'address': place.address_components[0].long_name
                    }
                });
            }
            // The search itself
            function search() {

                var markers = [];
                var input = /** @type {HTMLInputElement} */(
                        document.getElementById('search'));
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                var searchBox = new google.maps.places.SearchBox(
                        /** @type {HTMLInputElement} */(input));

                // Listen for the event fired when the user selects an item from the
                // pick list. Retrieve the matching places for that item.
                google.maps.event.addListener(searchBox, 'places_changed', function() {
                    var places = searchBox.getPlaces();

                    if (places.length == 0) {
                        return;
                    }
                    for (var i = 0, marker; marker = markers[i]; i++) {
                        marker.setMap(null);
                    }

                    // For each place, get the icon, place name, and location.
                    markers = [];
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0, place; place = places[i]; i++) {
                        var image = {
                            url: place.icon,
                            size: new google.maps.Size(71, 71),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(17, 34),
                            scaledSize: new google.maps.Size(25, 25)
                        };

                        // Create a marker for each place.
                        var marker = new google.maps.Marker({
                            map: map,
                            icon: image,
                            title: place.name,
                            position: place.geometry.location
                        });

                        markers.push(marker);

                        bounds.extend(place.geometry.location);
                    }

                    map.fitBounds(bounds);
                });

                // Bias the SearchBox results towards places that are within the bounds of the
                // current map's viewport.
                google.maps.event.addListener(map, 'bounds_changed', function() {
                    var bounds = map.getBounds();
                    searchBox.setBounds(bounds);
                });
            }
            // Add a marker to the map and push to the array.
            function addMarker(lat, location) {
                var marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
                loc = location;
                markers.push(marker);
                var infowindow = new google.maps.InfoWindow({
                    content: lat.formatted_address
                });
                infowindow.open(map, marker);
            }
            // Sets the map on all markers in the array.
            function setAllMap(map1) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(map1);
                }
            }
            // Removes the markers from the map, but keeps them in the array.
            function clearMarkers() {
                setAllMap(null);
            }
            // Deletes all markers in the array by removing references to them.
            function deleteMarkers() {
                clearMarkers();
                markers = [];
            }
            // Request the JSON for the marker
            function marker() {
                google.maps.event.addListener(map, 'click', function(event) {
                    $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?latlng=" + event.latLng.k + "," + event.latLng.B, function(result) {
                        deleteMarkers();
                        addMarker(result.results[0], event.latLng);
                    });
                });
            }

            //Function for the initialization of the map
            function initialize() {
                directionsDisplay = new google.maps.DirectionsRenderer();
                var center = new google.maps.LatLng(45.943161, 24.966760000000022);
                //Options for the map
                var mapOptions = {
                    zoom: 6,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    center: center
                };
                map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                directionsDisplay.setMap(map);
                //input autocomplet listeners
                pickup();
                dropoff();
                sch();
                search();
                marker();
            }
            google.maps.event.addDomListener(window, 'load', initialize);

        </script>

        <input id="pickup" type="text"
               placeholder="From">
        <input id="dropoff" type="text"
               placeholder="To">
        <input type="button" onclick="route()" value="Get Route">
        <button onclick="price()">Get Price </button>
        <input id="search" type="text" 
               placeholder="Search">
        <div id="json" onclick=""></div>
        <div id="map-canvas" style="
             height: 500px;
             width: 600px;"></div>
        <div id="right" style="
             position: absolute;
             right: 3px;
             top: 40px;
             height: 400px;
             width: 600px">
        </div>
    </body>
</html>